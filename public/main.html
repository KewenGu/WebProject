<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title></title>
  <link rel="stylesheet" href="css/main.css">
  <!-- Latest compiled and minified CSS -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
  <link rel="stylesheet" href="//code.jquery.com/ui/1.11.4/themes/smoothness/jquery-ui.css">
  <script src="//code.jquery.com/jquery-1.10.2.js"></script>
  <script src="//code.jquery.com/ui/1.11.4/jquery-ui.js"></script>
  <!-- Latest compiled and minified JavaScript -->
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>
  <script type="text/JavaScript" src="http://underscorejs.org/underscore-min.js" ></script>
  <script type="text/javascript" src="template.js"></script>
</head>
<body>
<div id="username" hidden></div>
<div id="login-page" class="container">
  <div class="row" id="forms">
    <div class="forms col-sm-4">
      <form>
        <h3 class="header-note"><b>Login</b></h3>
        <br>
        <div class="form"><label for="login-username">User Name: </label><input type="text" id="login-username" class="textfield" required></div>
        <br>
        <div class="form"><label for="login-password">Password: </label><input type="password" id="login-password" class="textfield" required></div>
        <br>
        <div id="login-notif"></div>
        <input type="submit" value="Login" class="button" onclick="login();">
      </form>
    </div>
    <div class="forms col-lg-4">
      <form>
        <h3 class="header-note"><b>Sign Up</b></h3>
        <br>
        <div class="form"><label for="signup-username">User Name: </label><input type="text" id="signup-username" class="textfield" required></div>
        <br>
        <div class="form"><label for="signup-password">Password: </label><input type="password" id="signup-password" class="textfield" required></div>
        <br>
        <div class="form"><label for="signup-email">Email: </label><input type="email" id="signup-email" class="textfield" required></div>
        <br>
        <div id="signup-notif"></div>
        <input type="submit" value="Sign Up" class="button" onclick="signup();">
      </form>
    </div>
  </div>
</div>

<div id="main-page" hidden>

  <nav class="navbar navbar-default navbar-fixed-top">
    <div class="container">
      <!-- Brand and toggle get grouped for better mobile display -->
      <div class="navbar-header">

        <a class="navbar-brand" href="#">Brand</a>
      </div>
      <!-- Collect the nav links, forms, and other content for toggling -->
      <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
        <ul class="nav navbar-nav">
          <!-- <li class="active"><a href="#">Link <span class="sr-only">(current)</span></a></li> -->
          <li><a href="#">Link</a></li>
        </ul>
        <!-- <form class="navbar-form navbar-left" role="search">
          <div class="form-group">
            <input type="text" class="form-control" placeholder="Search">
          </div>
          <button type="submit" class="btn btn-default">Submit</button>
        </form> -->
        <ul class="nav navbar-nav navbar-right">
          <li><a href="#">Notification</a></li>
          <li><a href="#">Sign out</a></li>
        </ul>
      </div><!-- /.navbar-collapse -->
      <div class="row">
        <div class="col-sm-4">
          Filter by:
          <input type="search" name="filter" value="">
        </div>
        <div class="col-sm-4">
          Sort by:
          <input type="search" name="sort" value="">
        </div>
        <div class="col-sm-4">
          <button id="add-one">
            Add a new <span class="glyphicons glyphicons-plus"></span>
          </button>
        </div>
      </div>
    </div><!-- /.container-fluid -->
  </nav>
  <div id="main-part" class="container">
    <div class="col-sm-4" id="note1">
      <h3 id="note1-title">Now led tedious shy lasting females off</h3>
      <p>Over fact all son tell this any his. No insisted confined of weddings to returned to debating rendered. Keeps order fully so do party means young. Table nay him jokes quick. In felicity up to graceful mistaken horrible consider. Abode never think to at. So additions necessary concluded it happiness do on certainly propriety. On in green taken do offer witty of.</p>
    </div>

  </div>

</div>
</body>


<dialog id="add-dialog">
  <div class="add-note">
    <input id="add-close" class="close-edit" type="button" name="close" value="Close"><br>
    <form onsubmit="return false;">
      <input type="checkbox" id="add-star" name="isStar" value="isStar"><label for="isStar">Star it</label>
      <label for="add-share" class="share-edit"> Share to :</label>
      <input type="text" id = "add-share" name="share" placeholder="Username/Email">
      <br>
      <br>
      <br>
      <label for="add-title"> Title</label>
      <input type="text" name="title" id="add-title" placeholder="Edit your title here"><br>
      <!-- <p style="display: inline-block;" class="time-edit">Time Last Edited:&nbsp;<p style="display: inline-block;">December 10th 2:36PM </p></p> -->
      <p>Attached File : </p><div class="attachment"><input type="file" name="attachFile" value=""></div>
      <input type="button" name="reminder" value="Email Notify" onclick = "emailSend();" class="reminder">
      <br>
      <br>
      <label for="add-content">Contents:</label>
      <br>
      <br>
      <textarea id="add-content" name="contents" rows = "10" cols = "60"></textarea><br>
      <input type="button" value="Save" onclick="addNote();">
      <input type="reset" name="Reset" value="Reset">
    </form>
  </div>
</dialog>

<dialog id="edit-dialog">
  <div class="edit-note">
    <p id="edit-id" hidden></p>
    <input id="edit-close" class="close-edit" type="button" name="close" value="Close"><br>
    <form onsubmit="return false;">
      <input type="checkbox" id="edit-star" name="isStar" value="isStar"><label for="isStar">Star it</label>
      <label for="edit-share" id="edit-share" class="share-edit"> Share to :</label>
      <input type="text" name="share" placeholder="Username/Email">
      <br>
      <br>
      <br>
      <label for="edit-title"> Title</label>
      <input type="text" name="title" id="edit-title" class="edittitle" placeholder="Edit your title here"><br>
      <p style="display: inline-block;" class="time-edit">Time Last Edited:&nbsp;<p style="display: inline-block;">December 10th 2:36PM </p></p>
      <p style="display: inline-block;" class="time-edit">Created time:&nbsp;<p style="display: inline-block;" id="edit-create-time">December 10th 2:36PM </p></p>
      <p>Attached File : </p><div class="attachment"><input type="file" name="attachFile" value=""></div>
      <input type="button" name="reminder" value="Email Notify" onclick = "emailSend();" class="reminder">
      <br>
      <br>
      <label for="edit-content">Contents:</label>
      <br>
      <br>
      <textarea id="edit-content" rows = "10" cols = "60"></textarea><br>
    </form>
    <input type="button" value="Save" onclick="editNote();">
    <input type="button" value="Delete" onclick="deleteNote();">
  </div>
</dialog>

<script type="text/javascript">
  var username;
  var notif;
  function login() {
    var el1 = document.getElementById("login-username");
    var el2 = document.getElementById("login-password");

    username = el1.value;
    console.log(username);
    var req = new XMLHttpRequest();
    req.open('POST', '/login', true);
    req.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');


    req.onload = function () {
      notif = '#login-notif';
      makeGet('/status', notif);
    };
    req.send('username=' + el1.value + '&password=' + el2.value);
  }

  function signup() {
    var el1 = document.getElementById("signup-username");
    var el2 = document.getElementById("signup-password");
    var el3 = document.getElementById("signup-email");

    var req = new XMLHttpRequest();
    req.open('POST', '/signup', true);
    req.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');

    req.onload = function () {
      notif = '#signup-notif';
      makeGet('/status', notif);
    };
    req.send('username=' + el1.value + '&password=' + el2.value + '&email=' + el3.value);

  }



  makeGet('/login', "#login-notif");
  makeGet('/signup', "#signup-notif");


  function makeGet(url, id) {
    var req = new XMLHttpRequest();

    req.onreadystatechange = function() {
      handleRes(req, id);
    };

    req.open('GET', url);
    req.send();
  }

  function handleRes(req, id) {
    if( req.readyState !== XMLHttpRequest.DONE )
      return;

    if(req.status === 200) {
      console.log(id);
      // console.log(req.responseText);
      var temp = req.responseText.split('&');
      if (id === "#login-notif" && temp[0] === "Done") {
        console.log(temp[1]);
        var user = JSON.parse(temp[1]);
        console.log("proceed into main page");
        document.getElementById("login-page").hidden = true;
        document.getElementById("main-page").hidden = false;
        document.getElementById('username').innerText = user.username;
        console.log(user.username);
        // console.log(document.getElementById('username').innerText);
        buildTable(user);
      }
      else if (id === "#signup-notif" && temp[0] === "Done") {
        document.querySelector(id).innerText = "Your account has been created!";
      }
      else {
        document.querySelector(id).innerText = temp[0];
      }
    }
  }

  function validateEmail(email) {
    var re = /^(([^<>()[\]\\.,;:\s@"]+(\.[^<>()[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
    return re.test(email);
  }




  var sample = {
    title: "It sportsman earnestly ye preserved an on",
    contents: "Too cultivated use solicitude frequently. Dashwood likewise up consider continue entrance ladyship oh. Wrong guest given purse power is no. Friendship to connection an am considered difficulty. Country met pursuit lasting moments why calling certain the. Middletons boisterous our way understood law. Among state cease how and sight since shall. Material did pleasure breeding our humanity she contempt had. So ye really mutual no cousin piqued summer result."
    // createdTime:
  };

  window.onload = function () {
    // var addOne = document.getElementById('addOne');
    var notesContener = document.getElementById('main-part');
    var addNoteDialog = document.getElementById('addNote');

    var editDialog = document.getElementById('edit-dialog');

    $('#note1').click(function (e) {
      e.preventDefault();
      document.getElementById('edit-title').value = document.getElementById('note1-title').innerText;
      // document.getElementById('add-content').value = document.getElementById('note1-title').innerText;
      editDialog.showModal();
      console.log(editDialog);
      console.log(this);
    });
    $('#edit-close').click(function () {
      editDialog.close();
    });

    var addDialog = document.getElementById('add-dialog');

    $('#add-one').click(function (e) {
      e.preventDefault();
      // $('#add-title').value = this.getElementsByTagName('h3').innerText;
      addDialog.showModal();
      // console.log(addDialog);
      // console.log(this);
    });
    $('#add-close').click(function () {

      // $('#add-star').attr('checked', false);
      // $('#add-title').removeAttr('value');
      // $('#add-content').removeAttr('value');

      addDialog.close();
    });

    var inputEl = document.getElementById("note1-title");
     function getWidthOfInput() {
       var tmp = document.createElement("span");
       tmp.className = "edittitle tmp-element";
       tmp.innerHTML = inputEl.innerText.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
       document.body.appendChild(tmp);
       var theWidth = tmp.getBoundingClientRect().width;
       document.body.removeChild(tmp);
      console.log(theWidth);
       return theWidth;
     }
     function adjustWidthOfInput() {
       document.getElementById("edit-title").style.width = getWidthOfInput() + "px";
     }
     adjustWidthOfInput();
     inputEl.onkeyup = adjustWidthOfInput;

  };

  function addNote() {
    var isStar = document.getElementById('add-star');
    var share = document.getElementById('add-share');
    var title = document.getElementById('add-title');
    var contents = document.getElementById('add-content');

    var reqp = new XMLHttpRequest();
    reqp.open('POST', '/add', true);
    reqp.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');

    var query = "";
    if(isStar.checked)
      query += 'isStar=' +isStar.checked +'&';
    query += 'share=' + share.value + '&';
    query += 'title=' + title.value + '&';
    query += 'contents=' + contents.value + '&';
    query += 'username=' + document.getElementById('username').innerText;
    var sendStr = query.split(' ').join('+');
    reqp.send(sendStr);
    console.log(sendStr);

    reqp.onreadystatechange = function () {
      if(reqp.readyState == 4 && reqp.status == 200){
        var resp = JSON.parse(reqp.responseText);
        console.log(resp);
        buildTable(resp);
      }
    }
    document.getElementById('add-dialog').close();

  }
  function deleteNote() {
    // console.log('delete');
    var id = document.getElementById('edit-id');

    var reqp = new XMLHttpRequest();
    reqp.open('POST', '/delete', true);
    reqp.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');

    var query = "";
    query += 'username=' + document.getElementById('username').innerText + '&';
    query += 'id=' + id.innerText;
    reqp.send(query);
    console.log(query);

    reqp.onreadystatechange = function () {
      if(reqp.readyState == 4 && reqp.status == 200){
        var resp = JSON.parse(reqp.responseText);
        console.log(resp);
        buildTable(resp);
      }
    }
    document.getElementById('edit-dialog').close();
  }
  function editNote() {
    var id = document.getElementById('edit-id');
    var isStar = document.getElementById('edit-star');
    // var share = document.getElementById('edit-share');
    var title = document.getElementById('edit-title');
    var contents = document.getElementById('edit-content');

    var reqp = new XMLHttpRequest();
    reqp.open('POST', '/edit', true);
    reqp.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');

    var query = "";
    if(isStar.checked)
      query += 'isStar=' + isStar.checked +'&';
    query += 'title=' + title.value + '&';
    query += 'contents=' + contents.value + '&';
    query += 'username=' + document.getElementById('username').innerText + '&';
    query += 'id=' + id.innerText;
    var sendStr = query.split(' ').join('+');
    reqp.send(sendStr);
    console.log(sendStr);

    reqp.onreadystatechange = function () {
      if(reqp.readyState == 4 && reqp.status == 200){
        var resp = JSON.parse(reqp.responseText);
        console.log(resp);
        buildTable(resp);
      }
    }
    document.getElementById('edit-dialog').close();
  }
  function buildTable(user) {
    var mainPart = document.getElementById('main-part');
    mainPart.innerHTML = '';
    var tempNote;

    user.notes.forEach(function (note) {
      // console.log(note);
      tempNote = document.createElement('div');
      tempNote.setAttribute("class", "col-sm-4");
      if(note.isStar){
        tempNote.innerHTML = noteTemplate_notStarred(note);
      }
      else {
        tempNote.innerHTML = noteTemplate_starred(note);
      }
      mainPart.appendChild(tempNote);

      var editDialog = document.getElementById('edit-dialog');
      tempNote.addEventListener('click', function (e) {
        e.preventDefault();
        // console.log(this);
        document.getElementById('edit-title').value = this.querySelector('h3').innerText;
        document.getElementById('edit-create-time').innerText = this.querySelector('.note-create-time').innerText;
        document.getElementById('edit-content').value = this.querySelector('.note-content').innerText;
        // console.log(document.getElementById('edit-content').value);
        document.getElementById('edit-id').innerText = this.querySelector('.note-id').innerText;
        editDialog.showModal();
        // console.log(editDialog);

      });

    });
    if(user.notes.length==0){
      tempNote = document.createElement('div');
      tempNote.innerHTML = "<h1>You are new here.</h1>";
      mainPart.appendChild(tempNote);
    }
  }
</script>
</html>
